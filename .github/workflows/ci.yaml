name: CI

on: [push, pull_request]

env:
  cache-version: v12

jobs:

#################################################################
# Linux
#################################################################

  test-and-build-linux:
    strategy:
      matrix:
        go-version: [1.24.x]
        platform: [ubuntu-24.04]
    runs-on: ${{ matrix.platform }}
    env:
      GOPATH: ${{ github.workspace }}
      #QT_DIR: ${{ github.workspace }}/Qt
      #QT_VERSION: ${{ matrix.qtversion }}
      QT_API: 5.13.0
      QT_DEBUG: false
      GO111MODULE: on
      #QT_STATIC: true
      #QT_QMAKE_DIR: ${{ github.workspace }}/Qt/${{ matrix.qtversion }}/gcc_64/bin
      QT_PKG_CONFIG: true
      CGO_CXXFLAGS: "-Wno-deprecated-declarations -O2"
    steps:
    - name: Linux prerequisites 
      run: |
        sudo apt update
        sudo apt-get -y install build-essential libglu1-mesa-dev libpulse-dev libglib2.0-dev cmake
        sudo apt-get --no-install-recommends -qq -y install fontconfig libasound2t64 libegl1 libnss3 libpci3 libxcomposite1 libxcursor1 libxi6 libxrandr2 libxtst6
        sudo apt-get --no-install-recommends -qq -y install libdbus-1-dev libssl-dev libzstd-dev
        sudo apt-get install '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev
        sudo apt-get install libwayland-dev libwayland-egl++ wayland-scanner++
        sudo apt-get --no-install-recommends install libqt*5-dev qt*5-dev qml-module-qtquick-* qt*5-doc-html
        sudo apt install -y build-essential cmake qtbase5-dev qtbase5-dev-tools qtchooser qt5-qmake
        sudo apt install -y \
          qtdeclarative5-dev qml-module-qtquick-controls qml-module-qtquick-controls2 \
          qml-module-qtgraphicaleffects \
          qtmultimedia5-dev qml-module-qtmultimedia \
          qttools5-dev qttools5-dev-tools 
        sudo apt install -y libwayland-dev wayland-protocols

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}

    - name: Free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        sudo rm -rf /usr/share/dotnet

    - name: Get dependencies
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make deps

    - name: Get Qt binding for Go
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make qt_bindings

    - name: Test
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make test

    - name: Build
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make app

    - name: Archive
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy
        mv linux goneovim-linux
        tar -jcvf goneovim-linux.tar.bz2 goneovim-linux

    - name: Upload for linux
      uses: actions/upload-artifact@v4
      with:
        name: goneovim-linux
        path: ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy/goneovim-linux.tar.bz2


#################################################################
# Linux ARM64
#################################################################

  test-and-build-linux-arm:
    strategy:
      matrix:
        go-version: [1.24.x]
        platform: [ubuntu-24.04-arm]
    runs-on: ${{ matrix.platform }}
    env:
      GOPATH: ${{ github.workspace }}
      #QT_DIR: ${{ github.workspace }}/Qt
      #QT_VERSION: ${{ matrix.qtversion }}
      QT_API: 5.13.0
      QT_DEBUG: false
      GO111MODULE: on
      #QT_STATIC: true
      #QT_QMAKE_DIR: ${{ github.workspace }}/Qt/${{ matrix.qtversion }}/gcc_64/bin
      QT_PKG_CONFIG: true
      CGO_CXXFLAGS: "-Wno-deprecated-declarations -O2"
    steps:
    - name: Linux prerequisites 
      run: |
        sudo apt update
        sudo apt-get -y install build-essential libglu1-mesa-dev libpulse-dev libglib2.0-dev cmake
        sudo apt-get --no-install-recommends -qq -y install fontconfig libasound2t64 libegl1 libnss3 libpci3 libxcomposite1 libxcursor1 libxi6 libxrandr2 libxtst6
        sudo apt-get --no-install-recommends -qq -y install libdbus-1-dev libssl-dev libzstd-dev
        sudo apt-get install '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev
        sudo apt-get install libwayland-dev libwayland-egl++ wayland-scanner++
        sudo apt-get --no-install-recommends install libqt*5-dev qt*5-dev qml-module-qtquick-* qt*5-doc-html
        sudo apt install -y build-essential cmake qtbase5-dev qtbase5-dev-tools qtchooser qt5-qmake
        sudo apt install -y \
          qtdeclarative5-dev qml-module-qtquick-controls qml-module-qtquick-controls2 \
          qml-module-qtgraphicaleffects \
          qtmultimedia5-dev qml-module-qtmultimedia \
          qttools5-dev qttools5-dev-tools 
        sudo apt install -y libwayland-dev wayland-protocols

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}

    - name: Free disk space
      run: |
        sudo swapoff -a
        sudo rm -f /swapfile
        sudo apt clean
        sudo rm -rf /usr/share/dotnet

    - name: Get dependencies
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make deps

    - name: Get Qt binding for Go
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make qt_bindings

    - name: Test
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make test

    - name: Build
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make app

    - name: Archive
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy
        mv linux goneovim-linux-arm
        tar -jcvf goneovim-linux-arm.tar.bz2 goneovim-linux-arm

    - name: Upload for linux ARM
      uses: actions/upload-artifact@v4
      with:
        name: goneovim-linux-arm
        path: ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy/goneovim-linux-arm.tar.bz2


#################################################################
# MacOS
#################################################################

  test-and-build-macos-x86_64:
    strategy:
      matrix:
        go-version: [1.24.x]
        platform: [macos-13]
    runs-on: ${{ matrix.platform }}
    env:
      GOPATH: ${{ github.workspace }}
      QT_HOMEBREW: true
      QT_API: 5.13.0
      QT_DEBUG: false
      GO111MODULE: on
      QT_QMAKE_DIR: /usr/local/opt/qt@5/bin
      CGO_CXXFLAGS: "-Wno-deprecated-declarations -O2"
    steps:

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Check Go Version
      run: |
        go version

    - name: Install Qt for macOS
      run: |
        brew install qt@5

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}

    - name: Get dependencies
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make deps
    
    - name: Get Qt binding for Go
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make qt_bindings

    - name: Test
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make test

    - name: Build
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make app

    - name: Archive
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy
        mv darwin goneovim-macos-x86_64
        tar -jcvf goneovim-macos-x86_64.tar.bz2 goneovim-macos-x86_64

    - name: Upload for macos
      uses: actions/upload-artifact@v4
      with:
        name: goneovim-macos-x86_64
        path: ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy/goneovim-macos-x86_64.tar.bz2



#################################################################
# MacOS M1
#################################################################

  test-and-build-macos-arm64:
    strategy:
      matrix:
        go-version: [1.24.x]
        platform: [macos-14]
        qtversion: [5.15.16]
    runs-on: ${{ matrix.platform }}
    env:
      GOPATH: ${{ github.workspace }}
      QT_HOMEBREW: false
      QT_API: 5.13.0
      QT_VERSION: 5.15.12
      QT_DIR: ${{ github.workspace }}/qt5
      QT_STATIC: true
      QT_DEBUG: false
      GO111MODULE: on
      QT_QMAKE_DIR: ${{ github.workspace }}/qt5/bin
      CGO_CXXFLAGS: "-Wno-deprecated-declarations -O2"
    steps:

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Check Go Version
      run: |
        go version

    - name: Download pre built Qt
      run: |
        curl -L -o qt-macos-static-${{ matrix.qtversion }}.tar.bz2 https://github.com/akiyosi/qt-static-builds/releases/download/qt-static-${{ matrix.qtversion }}/qt-macos-arm64-${{ matrix.qtversion }}.tar.bz2
        tar xf qt-macos-static-${{ matrix.qtversion }}.tar.bz2
        mkdir qt5 && mv ./Users/runner/work/qt-static-builds/qt-static-builds/Qt/* qt5/

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}

    - name: Get dependencies
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make deps
    
    - name: Get Qt binding for Go
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make qt_bindings

    - name: Test
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make test

    - name: Build
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
        make app

    - name: Archive
      run: |
        cd ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy
        mv darwin goneovim-macos-arm64
        tar -jcvf goneovim-macos-arm64.tar.bz2 goneovim-macos-arm64

    - name: Upload for macos m1
      uses: actions/upload-artifact@v4
      with:
        name: goneovim-macos-arm64
        path: ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy/goneovim-macos-arm64.tar.bz2


#################################################################
# Windows
#################################################################

# test

  test-and-build-windows-mingw:
    strategy:
      matrix:
        go-version: [1.24.0]
        platform: [windows-latest]
    runs-on: ${{ matrix.platform }}
    env:
      GOPATH: ${{ github.workspace }}
      QT_API: 5.13.0
      QT_MSYS2: true
      QT_MSYS2_DIR: C:\a\msys64\
      QT_MSVC: false
      QT_DEBUG: false
      GO111MODULE: on
      CGO_CFLAGS_ALLOW: ".*" 
      CGO_CXXFLAGS_ALLOW: ".*" 
      CGO_LDFLAGS_ALLOW: ".*" 
      CGO_CXXFLAGS: "-Wno-deprecated-declarations -O2"
      # CGO_ENABLED: 1
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      # QT_BINDING_VER: "v0.0.0-20240304155940-b43fff373ad5"
      QT_BINDING_VER: "v0.0.0-20251021043539-c059a317d6ad"
    steps:

    - name: Setup MSYS2 and install Qt5
      uses: msys2/setup-msys2@v2
      with:
        update: true
        msystem: mingw64
        install: mingw-w64-x86_64-toolchain
        location: C:\a\

    - shell: msys2 {0}
      run: |
        pacman --noconfirm -S sed git make tree mingw-w64-x86_64-toolchain mingw-w64-x86_64-qt5 mingw-w64-x86_64-angleproject

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ${{ env.GOPATH }}\src\github.com\${{ github.repository }}

    - name: Get dependencies
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/x64/bin/:$PATH
        cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        make deps

    - name: Get Qt binding for Go
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/x64/bin/:$PATH
        cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        go get github.com/akiyosi/qt@${{ env.QT_BINDING_VER }}
        go get github.com/akiyosi/qt/internal/cmd@${{ env.QT_BINDING_VER }}
        go get github.com/akiyosi/qt/internal/cmd/moc@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtdeploy@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtminimal@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtmoc@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtrcc@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtsetup@${{ env.QT_BINDING_VER }}
        $(go env GOPATH)/bin/qtsetup -test=false
        $(go env GOPATH)/bin/qtmoc desktop ./cmd/goneovim

    - name: Test
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/x64/bin/:$PATH
        cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        make test

    - name: Build
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/x64/bin/:$PATH
        cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        $(go env GOPATH)/bin/qtdeploy build desktop ./cmd/goneovim
        cp -pR runtime cmd/goneovim/deploy/windows/

    - name: Rename
      shell: msys2 {0}
      run: |
        cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}/cmd/goneovim/deploy
        mv windows goneovim-windows

    - name: Upload for windows
      uses: actions/upload-artifact@v4
      with:
        name: goneovim-windows
        path: D:/a/goneovim/goneovim/src/github.com/${{ github.repository }}/cmd/goneovim/deploy




#################################################################
# Windows ARM
#################################################################

# test

  test-and-build-windows-mingw-arm:
    strategy:
      matrix:
        go-version: [1.24.0]
        platform: [windows-11-arm]
    runs-on: ${{ matrix.platform }}
    env:
      GOPATH: ${{ github.workspace }}
      QT_API: 5.13.0
      QT_MSYS2: true
      QT_MSYS2_ARCH: "arm64"
      QT_MSYS2_DIR: /
      QT_QMAKE_DIR: /clangarm64/bin
      QT_MSVC: false
      QT_DEBUG: false
      GO111MODULE: on
      CGO_CFLAGS:   "--target=aarch64-w64-mingw32 -O2"
      CGO_CXXFLAGS: "--target=aarch64-w64-mingw32 -Wno-deprecated-declarations -Wno-ignored-attributes -DQT_CORE_LIB -O2"
      #CGO_LDFLAGS:  "--target=aarch64-w64-mingw32"
      CGO_LDFLAGS: "--target=aarch64-w64-mingw32 -L/clangarm64/lib -lQt5Widgets -lQt5Gui -lQt5Core -lQt5Network -lQt5Svg -lQt5Multimedia -lQt5PrintSupport -lQt5Qml -lQt5Quick -lstdc++ -lole32 -luuid -lws2_32 -luser32 -lgdi32 -lopengl32 -lwinmm"
      CPATH: "/clangarm64/include/QtScriptTools/5.15.17/QtScriptTools/private:/clangarm64/include/QtScriptTools:/clangarm64/include/QtScript/5.15.17/QtScript/private:/clangarm64/include/QtScript:/clangarm64/include/QtRemoteObjects/5.15.17/QtRemoteObjects/private:/clangarm64/include/QtRemoteObjects:/clangarm64/include/QtQuick/5.15.17/QtQuick/private:/clangarm64/include/QtQuick:/clangarm64/include/QtQml/5.15.17/QtQml/private:/clangarm64/include/QtQml:/clangarm64/include/QtDesigner/5.15.17/QtDesigner/private:/clangarm64/include/QtDesigner:/clangarm64/include/QtPrintSupport/5.15.17/QtPrintSupport/private:/clangarm64/include/QtPrintSupport:/clangarm64/include/QtOpenGL/5.15.17/QtOpenGL/private:/clangarm64/include/QtOpenGL:/clangarm64/include/QtSvg/5.15.17/QtSvg/private:/clangarm64/include/QtSvg:/clangarm64/include/QtMultimedia/5.15.17/QtMultimedia/private:/clangarm64/include/QtMultimedia:/clangarm64/include/QtDBus/5.15.17/QtDBus/private:/clangarm64/include/QtDBus:/clangarm64/include/QtNetwork/5.15.17/QtNetwork/private:/clangarm64/include/QtNetwork:/clangarm64/include/QtWidgets/5.15.17/QtWidgets/private:/clangarm64/include/QtWidgets:/clangarm64/include/QtGui/5.15.17/QtGui/private:/clangarm64/include/QtGui:/clangarm64/include/QtCore/5.15.17/QtCore/private:/clangarm64/include/QtCore:/clangarm64/include"
      LIBRARY_PATH: /clangarm64/lib
      CC:  "aarch64-w64-mingw32-clang"
      CXX: "aarch64-w64-mingw32-clang++"
      AR:  "llvm-ar"
      RANLIB: "llvm-ranlib"
      NM:  "llvm-nm"
      #PKG_CONFIG: "aarch64-w64-mingw32-pkg-config"
      PKG_CONFIG: "/clangarm64/bin/pkg-config"
      PKG_CONFIG_PATH: "/clangarm64/lib/pkgconfig"
      MSYSTEM: "CLANGARM64"
      # CGO_ENABLED: 1
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      #QT_BINDING_VER: "v0.0.0-20240304155940-b43fff373ad5"
      QT_BINDING_VER: "v0.0.0-20251021043539-c059a317d6ad"
    steps:

    - name: Setup MSYS2 (ARM64) and install Qt5
      uses: msys2/setup-msys2@v2
      with:
        update: true
        msystem: clangarm64
        install: >
          mingw-w64-clang-aarch64-toolchain
          mingw-w64-clang-aarch64-llvm
          mingw-w64-clang-aarch64-pkgconf
          mingw-w64-clang-aarch64-angleproject
          mingw-w64-clang-aarch64-qt5-base
          mingw-w64-clang-aarch64-qt5-multimedia
          mingw-w64-clang-aarch64-qt5-svg
          mingw-w64-clang-aarch64-qt5-imageformats
          mingw-w64-clang-aarch64-qt5-tools
          mingw-w64-clang-aarch64-qt5-declarative
          mingw-w64-clang-aarch64-qt5-remoteobjects
          mingw-w64-clang-aarch64-qt5-script
          mingw-w64-clang-aarch64-qt5-quickcontrols2
        location: C:\a\

    - name: Setup tools
      shell: msys2 {0}
      run: |
        pacman --noconfirm -S sed git make tree

    - name: check qt5 libs
      continue-on-error: true
      shell: msys2 {0}
      run: |
        ls -l /clangarm64/
        ls -l /clangarm64/include/
        "$QT_QMAKE_DIR/qmake" -query QT_VERSION QT_INSTALL_HEADERS QT_INSTALL_LIBS

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ${{ env.GOPATH }}\src\github.com\${{ github.repository }}

    - name: Get dependencies
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/arm64/bin/:$PATH
        cd /c/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        make deps

    - name: Get Qt binding for Go
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/arm64/bin/:$PATH
        cd /c/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        go get github.com/akiyosi/qt@${{ env.QT_BINDING_VER }}
        go get github.com/akiyosi/qt/internal/cmd@${{ env.QT_BINDING_VER }}
        go get github.com/akiyosi/qt/internal/cmd/moc@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtdeploy@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtminimal@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtmoc@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtrcc@${{ env.QT_BINDING_VER }}
        go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtsetup@${{ env.QT_BINDING_VER }}
        $(go env GOPATH)/bin/qtsetup -test=false
        $(go env GOPATH)/bin/qtmoc desktop ./cmd/goneovim

    - name: Test
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/arm64/bin:/clangarm64/bin:$PATH
        cd /c/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        make test

    - name: Build ARM64 resource
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/arm64/bin:/clangarm64/bin:$PATH
        cd /c/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        /clangarm64/bin/llvm-windres -O coff -i cmd/goneovim/icon.rc -o cmd/goneovim/icon_windows_arm64.syso

    - name: Strip incompatible .syso (amd64)
      shell: msys2 {0}
      run: |
        cd /c/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        rm cmd/goneovim/icon_windows.syso

    - name: Build
      shell: msys2 {0}
      run: |
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/arm64/bin:/clangarm64/bin:$PATH
        cd /c/a/goneovim/goneovim/src/github.com/${{ github.repository }}
        $(go env GOPATH)/bin/qtdeploy build desktop ./cmd/goneovim
        cp -pR runtime cmd/goneovim/deploy/windows/

    - name: install neovim
      shell: msys2 {0}
      run: |
        pacman --noconfirm -S mingw-w64-clang-aarch64-neovim

    - name: Headless smoke test (ARM64, MSYS2)
      shell: C:\a\_temp\setup-msys2\msys2.CMD {0}  # setup-msys2 の既定シェル
      env:
        QT_QPA_PLATFORM: offscreen
        QT_PLUGIN_PATH: /clangarm64/plugins
        EXTRA_BIN_DIR: /c/a/goneovim/goneovim/src/github.com/akiyosi/goneovim/cmd/goneovim/deploy/windows
      run: |
        set -euxo pipefail
        export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/arm64/bin:/clangarm64/bin:$PATH
        BIN="/c/a/goneovim/goneovim/src/github.com/akiyosi/goneovim/cmd/goneovim/deploy/windows/goneovim.exe"
        if [ ! -f "$BIN" ]; then
          echo "Not found: $BIN"
          exit 1
        fi
        export PATH="/clangarm64/bin:${EXTRA_BIN_DIR}:${PATH}"
        if "$BIN" --version >/dev/null 2>&1; then
          echo "--version succeeded"
        else
          echo "--version not supported; doing timed run..."
        fi
    
        set +e
        timeout -k 2s 10s "$BIN" >/dev/null 2>&1
        rc=$?
        set -e
    
        if [ $rc -eq 0 ] || [ $rc -eq 124 ]; then
          echo "Smoke test passed (rc=$rc)."
          exit 0
        else
          echo "Smoke test failed (rc=$rc)."
          exit $rc
        fi


    - name: Rename
      shell: msys2 {0}
      run: |
        cd /c/a/goneovim/goneovim/src/github.com/${{ github.repository }}/cmd/goneovim/deploy
        mv windows goneovim-windows-arm

    - name: Upload for windows ARM
      uses: actions/upload-artifact@v4
      with:
        name: goneovim-windows-arm
        path: C:/a/goneovim/goneovim/src/github.com/${{ github.repository }}/cmd/goneovim/deploy/goneovim-windows-arm




# # static build
# 
#   build-windows-mingw:
#     strategy:
#       matrix:
#         go-version: [1.24.0]
#         platform: [windows-latest]
#     runs-on: ${{ matrix.platform }}
#     env:
#       GOPATH: ${{ github.workspace }}
#       QT_API: 5.13.0
#       QT_MSYS2: true
#       QT_MSYS2_DIR: C:\a\msys64\
#       QT_MSYS2_STATIC: true
#       QT_MSVC: false
#       QT_DEBUG_CONSOLE: true
#       QT_DEBUG: false
#       GO111MODULE: on
#       CGO_CFLAGS_ALLOW: ".*" 
#       CGO_CXXFLAGS_ALLOW: ".*" 
#       CGO_LDFLAGS_ALLOW: ".*" 
#       CGO_CXXFLAGS: "-Wno-deprecated-declarations -O2"
#       ACTIONS_ALLOW_UNSECURE_COMMANDS: true
#       QT_BINDING_VER: "v0.0.0-20240304155940-b43fff373ad5"
#     steps:
# 
#     - name: Install Go
#       uses: actions/setup-go@v5
#       with:
#         go-version: ${{ matrix.go-version }}
# 
#     - name: Setup MSYS2 and install Qt5
#       uses: msys2/setup-msys2@v2
#       with:
#         update: true
#         msystem: mingw64
#         install: mingw-w64-x86_64-toolchain
#         location: C:\a\
# 
#     - name: Install Qt5
#       shell: msys2 {0}
#       run: |
#         pacman --noconfirm -S sed git make unzip zip mingw-w64-x86_64-qt-creator
#         pacman -Scc
#         pacman -Sc
#         curl -sL --retry 10 --retry-delay 60 -O  https://repo.msys2.org/mingw/x86_64/mingw-w64-x86_64-qt5-static-5.15.13-1-any.pkg.tar.zst
#         pacman -U --noconfirm mingw-w64-x86_64-qt5-static-5.15.13-1-any.pkg.tar.zst
# 
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0
#         path: ${{ env.GOPATH }}\src\github.com\${{ github.repository }}
#     
#     - name: Get dependencies
#       shell: msys2 {0}
#       run: |
#         export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/x64/bin/:$PATH
#         cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}
#         make deps
# 
#     - name: Get Qt binding for Go
#       shell: msys2 {0}
#       run: |
#         export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/x64/bin/:$PATH
#         cd /d/a/goneovim/goneovim//src/github.com/${{ github.repository }}
#         go get github.com/akiyosi/qt@${{ env.QT_BINDING_VER }}
#         go get github.com/akiyosi/qt/internal/cmd@${{ env.QT_BINDING_VER }}
#         go get github.com/akiyosi/qt/internal/cmd/moc@${{ env.QT_BINDING_VER }}
#         go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtdeploy@${{ env.QT_BINDING_VER }}
#         go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtminimal@${{ env.QT_BINDING_VER }}
#         go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtmoc@${{ env.QT_BINDING_VER }}
#         go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtrcc@${{ env.QT_BINDING_VER }}
#         go install -v -tags=no_env github.com/akiyosi/qt/cmd/qtsetup@${{ env.QT_BINDING_VER }}
#         $(go env GOPATH)/bin/qtsetup -test=false
#         $(go env GOPATH)/bin/qtmoc desktop ./cmd/goneovim
# 
#     - name: Build
#       shell: msys2 {0}
#       run: |
#         export PATH=/c/hostedtoolcache/windows/go/${{ matrix.go-version }}/x64/bin/:$PATH
#         cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}
#         $(go env GOPATH)/bin/qtdeploy build desktop ./cmd/goneovim
#         cp -pR runtime cmd/goneovim/deploy/windows/
# 
#     - name: Rename
#       shell: msys2 {0}
#       run: |
#         cd /d/a/goneovim/goneovim/src/github.com/${{ github.repository }}/cmd/goneovim/deploy
#         mv windows goneovim-windows
#       # zip -r goneovim-windows.zip goneovim-windows
# 
#     - name: Upload for windows
#       uses: actions/upload-artifact@v4
#       with:
#         name: goneovim-windows
#         path: D:/a/goneovim/goneovim/src/github.com/${{ github.repository }}/cmd/goneovim/deploy


  # test-and-build-windows-msvc:
  #   if: ${{ false }}
  #   strategy:
  #     matrix:
  #       platform: [windows-latest]
  #       qtversion: [5.14.1]
  #   runs-on: ${{ matrix.platform }}
  #   env:
  #     GOPATH: ${{ github.workspace }}
  #     GOROOT: ${{ github.workspace }}\go-root
  #     GOROOT_BOOTSTRAP: ${{ github.workspace }}\go-boot
  #     GOROOT_FINAL: ${{ github.workspace }}\go-boot
  #     GOVSVARSPATH: ${{ github.workspace }}\BuildTools\VC\Auxiliary\Build\vcvars64.bat
  #     MSVCDIR: 14.16.27023
  #     VSBUILDTOOLS_URL: https://aka.ms/vs/15/release/vs_buildtools.exe
  #     #VSBUILDTOOLS_URL: https://aka.ms/vs/17/release/vs_buildtools.exe
  #     QTARCH: msvc2017_64
  #     #QTARCH: msvc2019_64
  #     QT_VERSION: ${{ matrix.qtversion }}
  #     QT_DIR: C:\Qt
  #     QT_MSVC: true
  #     QT_DEBUG: false
  #     GO111MODULE: off
  #     ACTIONS_ALLOW_UNSECURE_COMMANDS: true
  #     #QT5BIN: qt5_static_binaries_win.zip
  #     QT5BIN: qt5_shared_binaries_win.zip
  #   steps:

  #   - name: Install Qt
  #     uses: jurplel/install-qt-action@v3
  #     with:
  #       version: ${{ matrix.qtversion }}
  #       host: windows
  #       target: desktop
  #       modules: 'qtcharts qtdatavis3d qtpurchasing qtvirtualkeyboard qtnetworkauth qtwebglplugin qtscript'
  #       arch: 'win64_${{ env.QTARCH }}'
  #       install-deps: 'true'
  #       dir: C:\
  #       # mirror: 'http://mirrors.ocf.berkeley.edu/qt/'

  #   #- name: Check dir
  #   #  continue-on-error: true
  #   #  run: |
  #   #    dir C:\Qt
  #   #    dir C:\Qt\${{ matrix.qtversion }}
  #   #    dir C:\Qt\${{ matrix.qtversion }}\${{ env.QTARCH }}

  #   - uses: actions/cache@v4
  #     id: cache-msvc-buildtools
  #     with:
  #       path: ${{ github.workspace }}\BuildTools
  #       key: ${{ matrix.qtversion }}-msvc-buildtools-${{ env.cache-version }}

  #   - name: Intall MSVC Visual C++ Buildtools
  #     if: ${{ steps.cache-msvc-buildtools.outputs.cache-hit != 'true' }}
  #     run: |
  #       curl -sL --retry 10 --retry-delay 60 -O ${{ env.VSBUILDTOOLS_URL }}
  #       New-Item -Path BuildTools -ItemType Directory 
  #       .\vs_BuildTools.exe --quiet --wait --norestart --nocache --installPath ${{ github.workspace }}\BuildTools --add Microsoft.VisualStudio.Workload.VCTools --includeOptional
  #       Start-Sleep -s 660

  #   - name: Check MSVC Visual C++ Buildtools installation
  #     run: |
  #       dir ${{ github.workspace }}\
  #       dir ${{ github.workspace }}\BuildTools
  #       dir ${{ github.workspace }}\BuildTools\VC
  #       dir ${{ github.workspace }}\BuildTools\VC\Tools
  #       dir ${{ github.workspace }}\BuildTools\VC\Tools\MSVC
  #       dir ${{ github.workspace }}\BuildTools\VC\Tools\MSVC\${{ env.MSVCDIR }}
  #       dir ${{ github.workspace }}\BuildTools\VC\Tools\MSVC\${{ env.MSVCDIR }}\bin
  #       dir ${{ github.workspace }}\BuildTools\VC\Tools\MSVC\${{ env.MSVCDIR }}\bin\Hostx64
  #       dir ${{ github.workspace }}\BuildTools\VC\Tools\MSVC\${{ env.MSVCDIR }}\bin\Hostx64\x64

  #   - name: Replace qt5 
  #     run: | 
  #       mkdir C:\qt-dl
  #       cd C:\qt-dl
  #       curl -sL --retry 10 --retry-delay 60 -O -L https://github.com/akiyosi/github-actions-playground/releases/download/qt5-static-msvc/${{ env.QT5BIN }}
  #       7z x ${{ env.QT5BIN }}
  #       del ${{ env.QT5BIN }}
  #       Remove-Item -Path C:\Qt\${{ matrix.qtversion }}\${{ env.QTARCH }} -Force -Recurse
  #       Copy-Item .\qt5-bin -destination C:\Qt\${{ matrix.qtversion }}\${{ env.QTARCH }} -recurse
  #       Remove-Item -Path C:\qt-dl\qt5-bin -Force -Recurse

  #   - name: Install Go 1.18 for "go get"
  #     run: |
  #       curl -sL --retry 10 --retry-delay 60 -O https://dl.google.com/go/go1.18.5.windows-amd64.zip
  #       expand-archive -path go1.18.5.windows-amd64.zip -destinationpath .
  #       Move-Item -Path go -Destination go-1.18

  #   - name: Get Qt binding for Go
  #     env:
  #       GOROOT: ${{ github.workspace }}\go-1.18
  #     run: |
  #       ${{ github.workspace }}\go-1.18\bin\go.exe get -v -tags=no_env github.com/akiyosi/qt/cmd/...

  #   - name: Install Go 1.13
  #     run: |
  #       curl -sL --retry 10 --retry-delay 60 -O https://dl.google.com/go/go1.13.4.windows-amd64.zip
  #       expand-archive -path go1.13.4.windows-amd64.zip -destinationpath .
  #       Move-Item -Path go -Destination go-root

  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     with:
  #       fetch-depth: 0
  #       path: ${{ env.GOPATH }}\src\github.com\${{ github.repository }}

  #   # FIXME: Should be fixed with the deprecation of set-env
  #   - name: Set PATH
  #     run: |
  #       $env:PATH = "${{ github.workspace }}\\go-root\\bin;$env:PATH"
  #       $env:PATH = "C:\\Qt\\${{ matrix.qtversion }}\\msvc2017_64\\bin;${{ github.workspace }}\\BuildTools\\VC\\Tools\\MSVC\\${{ env.MSVCDIR }}\\bin\\Hostx64\\x64;$env:PATH"
  #       echo "::set-env name=PATH::$env:PATH"

  #   - name: Enable experimental Go features Step.1
  #     continue-on-error: true
  #     run: |
  #       git clone https://github.com/golang/go.git ${{ github.workspace }}\go-msvc
  #       cd ${{ github.workspace }}\go-msvc
  #       git fetch "https://go.googlesource.com/go" refs/changes/46/133946/5
  #       Git checkout FETCH_HEAD
  #       echo "devel +6741b7009d" > VERSION

  #   - name: Enable experimental Go features Step.2
  #     continue-on-error: true
  #     run: |
  #       cd ${{ github.workspace }}\go-msvc
  #       curl -sL --retry 10 --retry-delay 60 https://github.com/golang/go/commit/e4535772ca3f11084ee5fa4d4bd3a542e143b80f.patch | patch -p1 -R

  #   - name: Enable experimental Go features Step.3
  #     continue-on-error: true
  #     run: |
  #       cd ${{ github.workspace }}\go-msvc
  #       curl -sL --retry 10 --retry-delay 60 https://github.com/golang/go/commit/f10815898c0732e2e6cdb697d6f95f33f8650b4e.patch | patch -p1 -R

  #   - name: Enable experimental Go features Step.4
  #     continue-on-error: true
  #     run: |
  #       cd ${{ github.workspace }}
  #       Move-Item -Path go-root -Destination go-boot
  #       Move-Item -Path go-msvc -Destination go-root
  #       cd ${{ github.workspace }}\go-root\src
  #       .\make.bat

  #   # - uses: actions/cache@v4
  #   #   id: cache-qt-bindings-windows
  #   #   with:
  #   #     path: |
  #   #       ${{ github.workspace }}\src\github.com\akiyosi\qt\*
  #   #       !${{ github.workspace }}\src\github.com\akiyosi\qt\.git
  #   #     key: ${{ matrix.qtversion }}-qtbindings-windows-${{ env.cache-version }}

  #   - name: Generate Qt bindings
  #     continue-on-error: true
  #     env:
  #       QT_API: 5.13.0
  #     shell: cmd
  #     run: |
  #       ${{ github.workspace }}\bin\qtsetup.exe prep windows
  #       ${{ github.workspace }}\bin\qtsetup.exe check windows
  #       ${{ github.workspace }}\bin\qtsetup.exe generate windows
  #       sed -i '9,14d' ${{ github.workspace }}\src\github.com\akiyosi\qt\core\core.cpp
  #       sed -i '661,666d' ${{ github.workspace }}\src\github.com\akiyosi\qt\internal\binding\templater\template_cpp.go
  #       ${{ github.workspace }}\bin\qtsetup.exe install windows
  # 
  #   - name: Get dependencies
  #     run: |
  #       go get -v -d github.com/${{ github.repository }}/...
  #       cd ${{ github.workspace }}\src\github.com\${{ github.repository }}
  #       ${{ github.workspace }}\bin\qtmoc.exe desktop ./cmd/goneovim

  #   # - name: Convert to compatible sources on Qt5.12
  #   #   if: ${{ matrix.qtversion == '5.12.6' }}
  #   #   run: |
  #   #     cd ${{ github.workspace }}\src\github.com\${{ github.repository }}
  #   #     $data=Get-Content  .\editor\workspace.go | % { $_ -replace "NewQVariant31", "NewQVariant33" }
  #   #     $data | Out-File   .\editor\workspace.go -Encoding UTF8
  #   #     $data=Get-Content  .\editor\popupmenu.go | % { $_ -replace "AddWidget2", "AddWidget" }
  #   #     $data | Out-File   .\editor\popupmenu.go -Encoding UTF8
  #   #     $data=Get-Content  .\editor\message.go | % { $_ -replace "AddWidget2", "AddWidget" }
  #   #     $data | Out-File   .\editor\message.go -Encoding UTF8
  #   #     $data=Get-Content  .\editor\window.go | % { $_ -replace "DrawText6", "DrawText5" }
  #   #     $data | Out-File   .\editor\window.go -Encoding UTF8
  #   #     $data=Get-Content  .\editor\screen.go | % { $_ -replace "NewQVariant5", "NewQVariant2" }
  #   #     $data | Out-File   .\editor\screen.go -Encoding UTF8
  #   #     $ch1="), text, gui.NewQTextOption2(core.Qt__AlignVCenter),"
  #   #     $rep1="), int(core.Qt__AlignVCenter), text, nil,"
  #   #     $data=Get-Content  .\editor\window.go | % { $_ -replace [regex]::Escape($ch1), $rep1 }
  #   #     $data | Out-File   .\editor\window.go -Encoding UTF8
  #   #     $data=Get-Content  .\editor\cursor.go | % { $_ -replace "DrawText6", "DrawText5" }
  #   #     $data | Out-File   .\editor\cursor.go -Encoding UTF8
  #   #     $data=Get-Content  .\editor\cursor.go | % { $_ -replace "NewQVariant10", "NewQVariant12" }
  #   #     $data | Out-File   .\editor\cursor.go -Encoding UTF8
  #   #     $ch2="), text, gui.NewQTextOption2(core.Qt__AlignVCenter),"
  #   #     $rep2="), int(core.Qt__AlignVCenter), text, nil,"
  #   #     $data=Get-Content  .\editor\cursor.go | % { $_ -replace [regex]::Escape($ch2), $rep2 }
  #   #     $data | Out-File   .\editor\cursor.go -Encoding UTF8
  #   #     $data=Get-Content  .\util\utils.go | % { $_ -replace "SetOffset2", "SetOffset3" }
  #   #     $data | Out-File   .\util\utils.go -Encoding UTF8

  #   # - name: Test
  #   #   env:
  #   #     QT_API: 5.13.0
  #   #   run: go test github.com\akiyosi\goneovim\editor

  #   - name: Retrieve version
  #     id: version-windows
  #     run: |
  #       cd ${{ github.workspace }}/src/github.com/${{ github.repository }}
  #       echo "::set-output name=GONEOVIM_VERSION::$(git describe --tags)"

  #   - name: Build
  #     env:
  #       QT_API: 5.13.0
  #     run: |
  #       cd ${{ github.workspace }}\src\github.com\${{ github.repository }}
  #       go generate
  #       ${{ github.workspace }}\bin\qtdeploy build desktop ./cmd/goneovim
  #       Copy-Item -Force -Recurse -Path ../../runtime -Destination ./deploy/windows/

  #   - name: Upload for windows
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: goneovim-windows-msvc
  #       path: ${{ github.workspace }}/src/github.com/${{ github.repository }}/cmd/goneovim/deploy/windows



############################################
# freebsd
############################################


#   test-and-build-freebsd:
#     runs-on: macos-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
# 
#       - name: Build for freeBSD
#         uses: cross-platform-actions/action@v0.13.0
#         env:
#           GOPATH: /home/runner/go
#           QT_PKG_CONFIG: true
#           QT_API: 5.13.0
#           QT_DEBUG: false
#           QT_STATIC: true
#           GO111MODULE: on
#           GOPROXY: https://goproxy.io
#           CGO_CPPFLAGS: '-O3 -Wno-deprecated'
#         with:
#           environment_variables: GOPATH QT_PKG_CONFIG QT_API QT_DEBUG QT_STATIC GO111MODULE GOPROXY
#           operating_system: freebsd
#           architecture: x86_64
#           version: '13.2'
#           shell: bash
#           memory: 12G
#           cpu_count: 4
#           run: |
#             yes | sudo pkg install git go pkgconf
#             yes | sudo pkg install devel/qt5
#             yes | sudo pkg install gmake
#             gmake qt_bindings
#             gmake deps
#             gmake test
#             gmake app
# 
#       - name: check dir
#         run: |
#           pwd
#           ls -l cmd/goneovim/deploy/freebsd
# 
#       - name: Archive
#         run: |
#           cd cmd/goneovim/deploy
#           mv freebsd goneovim-freebsd
#           tar -jcvf goneovim-freebsd.tar.bz2 goneovim-freebsd
#   
#       - name: Upload for freebsd
#         uses: actions/upload-artifact@v4
#         with:
#           name: goneovim-freebsd
#           path: ${{ github.workspace }}/cmd/goneovim/deploy/goneovim-freebsd.tar.bz2
